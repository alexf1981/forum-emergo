<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Logic Tests</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
        }

        h1 {
            border-bottom: 2px solid #555;
            padding-bottom: 10px;
        }

        .group {
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: #ccc;
        }

        .result {
            padding: 5px 10px;
            margin: 2px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            font-family: monospace;
            font-size: 1.1em;
        }

        .test-pass {
            background: #2e7d32;
            color: #fff;
        }

        .test-fail {
            background: #c62828;
            color: #fff;
        }

        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #333;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            font-size: 1.2em;
        }
    </style>
    <script src="gameLogic.js"></script>
</head>

<body>
    <h1>üõ°Ô∏è Unit Tests</h1>
    <div id="output">Running tests...</div>
    <div id="summary"></div>

    <script>
        const output = document.getElementById('output');
        const summary = document.getElementById('summary');
        let passes = 0;
        let fails = 0;
        let testCount = 0;

        function logGroup(name) {
            const div = document.createElement('div');
            div.className = 'group';
            div.textContent = name;
            output.appendChild(div);
        }

        function assert(condition, desc) {
            testCount++;
            const div = document.createElement('div');
            div.className = 'result ' + (condition ? 'test-pass' : 'test-fail');
            div.innerHTML = `<span>${desc}</span> <span>${condition ? 'PASS' : 'FAIL'}</span>`;
            output.appendChild(div);
            if (condition) passes++; else fails++;
        }

        function assertEqual(actual, expected, desc) {
            assert(actual === expected, `${desc} (Got: ${actual}, Expected: ${expected})`);
        }

        // --- Mock Random ---
        function createMockRandom(sequence) {
            let index = 0;
            return () => {
                if (index >= sequence.length) index = 0;
                return sequence[index++];
            };
        }

        function runTests() {
            output.innerHTML = '';

            // ==========================================
            logGroup("City Rank Logic");
            // ==========================================
            const stats = { gold: 0, army: 0, knowledge: 0 };

            stats.gold = 199; assertEqual(GameLogic.getCityRank(stats), "Dorp", "199 -> Dorp");
            stats.gold = 200; assertEqual(GameLogic.getCityRank(stats), "Handelspost", "200 -> Handelspost");
            stats.gold = 499; assertEqual(GameLogic.getCityRank(stats), "Handelspost", "499 -> Handelspost");
            stats.gold = 500; assertEqual(GameLogic.getCityRank(stats), "Stad", "500 -> Stad");
            stats.gold = 2500; assertEqual(GameLogic.getCityRank(stats), "Keizerlijk Forum Emergo", "2500 -> Keizerlijk");


            // ==========================================
            logGroup("Battle Logic");
            // ==========================================
            const heroStats = { str: 5, lvl: 1, items: [], hp: 20, maxHp: 20, xp: 80 };
            const questStats = { id: 'test', level: 1, risk: 2, reward: 50, xp: 30 };

            // RNG: Perf(0.5) > Diff(0.5), Dmg(0.1), Loot(0.9 Fail)
            const mockWin = createMockRandom([0.5, 0.5, 0.1, 0.9]);
            const resultWin = GameLogic.calculateBattleResult(heroStats, questStats, mockWin);

            assert(resultWin.success, "Win: Normal battle");
            assertEqual(resultWin.earnedGold, 50, "Win: Gold");
            assertEqual(resultWin.earnedXp, 30, "Win: XP");
            assert(resultWin.leveledUp, "Win: Level Up Triggered");
            assertEqual(resultWin.newLvl, 2, "Win: Level 1 -> 2");


            // ==========================================
            logGroup("Battle Logic: Loot");
            // ==========================================
            const heroLoot = { str: 10, lvl: 1, items: [], hp: 20, maxHp: 20, xp: 0 };
            // RNG: Perf(0.5), Diff(0.5), Dmg(0), Loot(0.1 Success), Item(0.0 First)
            const mockLootNew = createMockRandom([0.5, 0.5, 0.0, 0.1, 0.0]);
            const resultLoot = GameLogic.calculateBattleResult(heroLoot, { id: 'l', level: 1, risk: 1, reward: 10, xp: 10 }, mockLootNew);

            assert(resultLoot.newItems.length === 1, "Loot: Item added");
            assert(resultLoot.lootMsg.includes("GEVONDEN"), "Loot: Message correct");


            // ==========================================
            logGroup("Battle Logic: Defeat");
            // ==========================================
            const heroWeak = { str: 1, lvl: 1, items: [], hp: 10, maxHp: 10, xp: 0 };
            // RNG: Perf(0.1 Low), Diff(0.9 High) -> LOSS
            const mockLoss = createMockRandom([0.1, 0.9]);
            const resultLoss = GameLogic.calculateBattleResult(heroWeak, { id: 'd', level: 10, risk: 20, reward: 0, xp: 0 }, mockLoss);

            assert(resultLoss.success === false, "Defeat: Weak hero loses");
            assertEqual(resultLoss.hp, 0, "Defeat: HP 0 (Death)");


            // ==========================================
            logGroup("Habit Logic: CRUD");
            // ==========================================
            let habits = [];
            habits = GameLogic.createHabit(habits, "Gym", "virtue", false);
            assert(habits.length === 1, "Create: Virtue added");

            habits = GameLogic.createHabit(habits, "Task", "todo", true);
            assert(habits.length === 2, "Create: Task added");
            assertEqual(habits[1].bucket, true, "Create: Task is one-time");

            const id = habits[0].id;
            habits = GameLogic.updateHabit(habits, id, { text: "Gym Updated" });
            assertEqual(habits[0].text, "Gym Updated", "Update: Renamed");

            habits = GameLogic.deleteHabit(habits, id);
            assert(habits.length === 1, "Delete: Success");


            // ==========================================
            logGroup("Habit Logic: Toggling");
            // ==========================================
            // Note: Using 'habitStats' instead of 'stats' to avoid clash
            let habitStats = { gold: 100, army: 10 };
            let testHabits = [
                { id: 1, type: 'virtue', text: 'V', history: [] },
                { id: 2, type: 'vice', text: 'S', history: [] },
                { id: 3, type: 'todo', text: 'T', history: [], bucket: true }
            ];
            const date = "2025-01-01";

            // Toggle Virtue ON
            let r1 = GameLogic.processHabitToggle(testHabits, habitStats, 1, date);
            assertEqual(r1.newStats.gold, 110, "Virtue ON: Gold +10");

            // Toggle Virtue OFF (Undo)
            let r2 = GameLogic.processHabitToggle(r1.newHabits, r1.newStats, 1, date);
            assertEqual(r2.newStats.gold, 100, "Virtue OFF: Gold Refunded");

            // Toggle Vice ON
            let r3 = GameLogic.processHabitToggle(testHabits, habitStats, 2, date);
            assertEqual(r3.newStats.gold, 80, "Vice ON: Gold -20 (Penalty)");

            // Toggle Todo ON
            let r4 = GameLogic.processHabitToggle(testHabits, habitStats, 3, date);
            assertEqual(r4.newStats.gold, 150, "Task ON: Gold +50");


            // ==========================================
            summary.innerHTML = `Tests Completed: ${passes} / ${testCount} Passed.`;
            summary.style.color = fails === 0 ? '#4caf50' : '#ff4444';
        }

        setTimeout(runTests, 100);
    </script>
</body>

</html>