<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Logic Tests</title>
    <link rel="icon" type="image/jpeg" href="assets/nav_tavern.jpg?v=2">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/game.css">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
        }

        h1 {
            border-bottom: 2px solid #555;
            padding-bottom: 10px;
        }

        .group {
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: #ccc;
        }

        .result {
            padding: 5px 10px;
            margin: 2px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            font-family: monospace;
            font-size: 1.1em;
        }

        .test-pass {
            background: #2e7d32;
            color: #fff;
        }

        .test-fail {
            background: #c62828;
            color: #fff;
        }

        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #333;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            font-size: 1.2em;
        }
    </style>
</head>

<body>
    <h1>üõ°Ô∏è Unit Tests</h1>
    <div id="output">Running tests...</div>
    <div id="summary"></div>

    <script src="src/logic/gameLogic.js"></script>
    <script>
        const GameLogic = window.GameLogic;

        const output = document.getElementById('output');
        const summary = document.getElementById('summary');
        let passes = 0;
        let fails = 0;
        let testCount = 0;

        function logGroup(name) {
            const div = document.createElement('div');
            div.className = 'group';
            div.textContent = name;
            output.appendChild(div);
        }

        function assert(condition, desc) {
            testCount++;
            const div = document.createElement('div');
            div.className = 'result ' + (condition ? 'test-pass' : 'test-fail');
            div.innerHTML = `<span>${desc}</span> <span>${condition ? 'PASS' : 'FAIL'}</span>`;
            output.appendChild(div);
            if (condition) passes++; else fails++;
        }

        function assertEqual(actual, expected, desc) {
            assert(actual === expected, `${desc} (Got: ${actual}, Expected: ${expected})`);
        }

        // --- Mock Random ---
        function createMockRandom(sequence) {
            let index = 0;
            return () => {
                if (index >= sequence.length) index = 0;
                return sequence[index++];
            };
        }

        function runTests() {
            output.innerHTML = '';

            // ==========================================
            logGroup("City Rank Logic");
            // ==========================================
            const stats = { gold: 0, army: 0, knowledge: 0 };

            stats.gold = 199; assertEqual(GameLogic.getCityRank(stats), "Dorp", "199 -> Dorp");
            stats.gold = 200; assertEqual(GameLogic.getCityRank(stats), "Handelspost", "200 -> Handelspost");
            stats.gold = 499; assertEqual(GameLogic.getCityRank(stats), "Handelspost", "499 -> Handelspost");
            stats.gold = 500; assertEqual(GameLogic.getCityRank(stats), "Stad", "500 -> Stad");
            stats.gold = 2500; assertEqual(GameLogic.getCityRank(stats), "Keizerlijk Forum Emergo", "2500 -> Keizerlijk");


            // ==========================================
            logGroup("Battle Logic");
            // ==========================================
            const heroStats = { str: 5, lvl: 1, items: [], hp: 20, maxHp: 20, xp: 80 };
            const questStats = { id: 'test', level: 1, risk: 2, reward: 50, xp: 30 };

            // Note: Original code used Math.random inside calculateBattleResult. 
            // To pass mock random, we'd need to inject it or mock Math.random.
            // For now, testing logic without full RNG control if calculateBattleResult doesn't take random injector.

            const resultWin = GameLogic.calculateBattleResult(heroStats, questStats);
            assert(typeof resultWin.success === 'boolean', "Battle returns success flag");


            // ==========================================
            logGroup("Habit Logic: CRUD");
            // ==========================================
            let habits = [];
            habits = GameLogic.createHabit(habits, "Gym", "virtue", false);
            assert(habits.length === 1, "Create: Virtue added");

            habits = GameLogic.createHabit(habits, "Task", "todo", true);
            assert(habits.length === 2, "Create: Task added");
            assertEqual(habits[1].bucket, true, "Create: Task is one-time");

            const id = habits[0].id;
            habits = GameLogic.updateHabit(habits, id, { text: "Gym Updated" });
            assertEqual(habits[0].text, "Gym Updated", "Update: Renamed");

            habits = GameLogic.deleteHabit(habits, id);
            assert(habits.length === 1, "Delete: Success");


            // ==========================================
            logGroup("Habit Logic: Toggling");
            // ==========================================
            let habitStats = { gold: 100, army: 10 };
            let testHabits = [
                { id: 1, type: 'virtue', text: 'V', history: [] },
                { id: 2, type: 'vice', text: 'S', history: [] },
                { id: 3, type: 'todo', text: 'T', history: [], bucket: true }
            ];
            const date = "2025-01-01";

            // Toggle Virtue ON
            let r1 = GameLogic.processHabitToggle(testHabits, habitStats, 1, date);
            assertEqual(r1.newStats.gold, 110, "Virtue ON: Gold +10");

            // Toggle Virtue OFF (Undo)
            let r2 = GameLogic.processHabitToggle(r1.newHabits, r1.newStats, 1, date);
            assertEqual(r2.newStats.gold, 100, "Virtue OFF: Gold Refunded");

            // Toggle Vice ON
            let r3 = GameLogic.processHabitToggle(testHabits, habitStats, 2, date);
            assertEqual(r3.newStats.gold, 80, "Vice ON: Gold -20 (Penalty)");

            // Toggle Todo ON
            let r4 = GameLogic.processHabitToggle(testHabits, habitStats, 3, date);
            assertEqual(r4.newStats.gold, 150, "Task ON: Gold +50");


            // (Summary and Visual Tests continue below)

            // ==========================================
            logGroup("Visual Layout Tests (Desktop Simulation)");
            // ==========================================
            if (window.innerWidth >= 1024) {
                const testDiv = document.createElement('div');
                testDiv.style.position = 'absolute';
                testDiv.style.left = '-9999px';
                testDiv.style.width = '1000px';
                testDiv.innerHTML = `
                    <div class="city-columns-container">
                        <div class="city-col" id="col1">C1</div>
                        <div class="city-col" id="col2">C2</div>
                        <div class="city-col" id="col3">C3</div>
                    </div>
                `;
                document.body.appendChild(testDiv);

                const c1 = document.getElementById('col1');
                const c2 = document.getElementById('col2');
                const c3 = document.getElementById('col3');

                const y1 = c1.getBoundingClientRect().top;
                const y2 = c2.getBoundingClientRect().top;
                const y3 = c3.getBoundingClientRect().top;

                assert(Math.abs(y1 - y2) < 5 && Math.abs(y2 - y3) < 5, "Desktop: Columns are side-by-side (Horizontal)");

                const w1 = c1.offsetWidth;
                const w2 = c2.offsetWidth;
                assert(Math.abs(w1 - w2) < 50, `Desktop: Columns have similar width (${w1}px vs ${w2}px)`);

                document.body.removeChild(testDiv);
            } else {
                log("(!) Desktop Layout Test skipped: Window too narrow", "info");
            }

            // ==========================================
            logGroup("Visual Layout Tests (Mobile Simulation)");
            // ==========================================
            if (window.innerWidth <= 600) {
                const mobileTestDiv = document.createElement('div');
                mobileTestDiv.style.position = 'absolute';
                mobileTestDiv.style.left = '-9999px';
                mobileTestDiv.style.width = '100%';
                mobileTestDiv.innerHTML = `
                    <div class="bottom-nav">
                        <div class="bottom-nav-content">
                            <div class="nav-item edge-item" id="edge-left">E1</div>
                            <div class="nav-group-center">
                                <div class="nav-item role-left" id="m-left">L</div>
                                <div class="nav-item role-center" id="m-center">C</div>
                                <div class="nav-item role-right" id="m-right">R</div>
                            </div>
                            <div class="nav-item edge-item" id="edge-right">E2</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(mobileTestDiv);

                const mLeft = document.getElementById('m-left').getBoundingClientRect();
                const mCenter = document.getElementById('m-center').getBoundingClientRect();
                const mRight = document.getElementById('m-right').getBoundingClientRect();
                const eLeft = document.getElementById('edge-left').getBoundingClientRect();
                const eRight = document.getElementById('edge-right').getBoundingClientRect();

                const isOverlapping = (r1, r2) => {
                    return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
                };

                assert(!isOverlapping(eLeft, mLeft), "Mobile: Left Edge does not overlap Left Nav");
                assert(!isOverlapping(mLeft, mCenter), "Mobile: Left Nav does not overlap Center");
                assert(!isOverlapping(mCenter, mRight), "Mobile: Center does not overlap Right Nav");
                assert(!isOverlapping(mRight, eRight), "Mobile: Right Nav does not overlap Right Edge");

                document.body.removeChild(mobileTestDiv);
            } else {
                log("(!) Mobile Layout Test skipped: Window too wide", "info");
            }

            // Update summary with final tally
            summary.innerHTML = `Tests Completed: ${passes} / ${testCount} Passed.`;
            summary.style.color = fails === 0 ? '#4caf50' : '#ff4444';
        }

        setTimeout(runTests, 100);
    </script>
</body>

</html>